<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Background Remover</title>
<style>
  body {
    margin: 0;
    background: #181818;
    color: #eee;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  header {
    width: 100%;
    text-align: center;
    background: #222;
    padding: 10px;
    font-weight: bold;
    letter-spacing: 0.5px;
  }

  #container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 95%;
    max-width: 800px;
    margin: 15px 0;
  }

  video, canvas {
    width: 100%;
    max-width: 100%;
    border-radius: 8px;
    background: black;
  }

  #controls {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 10px;
  }

  button, select, input[type=file] {
    background: #333;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    transition: 0.2s;
  }

  button:hover, select:hover, input[type=file]:hover {
    background: #444;
  }

  #status {
    margin-top: 10px;
    font-size: 0.9em;
    color: #aaa;
  }
</style>
</head>
<body>
  <header>ðŸŽ¥ Smart Background Remover</header>
  <div id="container">
    <video id="video" controls></video>
    <canvas id="canvas"></canvas>
    <div id="controls">
      <input type="file" id="videoInput" accept="video/*">
      <select id="mode">
        <option value="preview">Preview</option>
        <option value="remove">Remove Background</option>
        <option value="edges">Edge Highlight</option>
      </select>
      <button id="startBtn">Start</button>
      <button id="stopBtn">Stop</button>
      <button id="saveBtn">Save</button>
    </div>
    <div id="status">Ready.</div>
  </div>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let statusEl = document.getElementById('status');

let running = false;
let mode = 'preview';
let bgSubtractor = null;

document.getElementById('videoInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  video.src = url;
  video.play();
});

document.getElementById('mode').addEventListener('change', e => {
  mode = e.target.value;
});

document.getElementById('startBtn').onclick = async () => {
  if (!video.src) {
    alert("Please select a video first.");
    return;
  }
  await initOpenCV();
  running = true;
  processLoop();
  statusEl.textContent = "Processing started...";
};

document.getElementById('stopBtn').onclick = () => {
  running = false;
  statusEl.textContent = "Stopped.";
};

document.getElementById('saveBtn').onclick = () => {
  const link = document.createElement('a');
  link.download = 'processed_video.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
};

async function initOpenCV() {
  if (typeof cv === "undefined") {
    statusEl.textContent = "Loading OpenCV...";
    await new Promise(resolve => {
      let script = document.createElement('script');
      script.src = "https://docs.opencv.org/4.x/opencv.js";
      script.onload = resolve;
      document.head.appendChild(script);
    });
  }
  await new Promise(resolve => {
    cv['onRuntimeInitialized'] = resolve;
  });
  bgSubtractor = new cv.BackgroundSubtractorMOG2(500, 16, true);
  statusEl.textContent = "OpenCV ready.";
}

async function processLoop() {
  if (!running) return;
  if (video.readyState >= 2) {
    if (canvas.width !== video.videoWidth) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    let src = cv.imread(canvas);
    let fgMask = new cv.Mat();

    if (mode === 'remove') {
      bgSubtractor.apply(src, fgMask);
      let result = new cv.Mat();
      cv.cvtColor(fgMask, fgMask, cv.COLOR_GRAY2RGBA);
      cv.bitwise_and(src, fgMask, result);
      cv.imshow(canvas, result);
      src.delete(); result.delete(); fgMask.delete();
    }
    else if (mode === 'edges') {
      cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
      cv.Canny(src, fgMask, 80, 150);
      cv.imshow(canvas, fgMask);
      src.delete(); fgMask.delete();
    }
    else {
      cv.imshow(canvas, src);
      src.delete();
    }
  }

  requestAnimationFrame(processLoop);
}
</script>
</body>
</html>