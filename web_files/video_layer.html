<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Video Processor</title>
<style>
:root {
  --bg:#0d1117; --panel:#0f1720; --muted:#8b949e;
  --accent:#58a6ff; --btn:#238636;
}
html,body{margin:0;padding:0;height:100%;background:var(--bg);color:#c9d1d9;font-family:Inter,sans-serif;display:flex;flex-direction:column;align-items:center;box-sizing:border-box;padding:12px;}
header{text-align:center;margin-bottom:8px;}
h1{margin:0;color:var(--accent);font-size:1.2rem;}
p.lead{margin:4px 0 0 0;color:var(--muted);}
main{width:100%;max-width:900px;display:flex;flex-direction:column;gap:12px;}
.mediaBox{background:#07080a;border:1px solid #16181c;border-radius:12px;padding:10px;}
.mediaInner{display:flex;flex-direction:column;align-items:center;gap:10px;}
video,canvas{width:100%;max-width:840px;border-radius:10px;background:#000;}
.controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;background:#0b0d10;border-radius:10px;border:1px solid #111317;padding:10px;}
button,select,input[type=file]{background:var(--btn);color:#fff;border:none;border-radius:8px;padding:10px;font-weight:600;cursor:pointer;}
button:disabled{opacity:0.6;cursor:not-allowed;}
.aux{background:#111315;color:var(--muted);}
.progressWrap{width:100%;margin-top:8px;}
.progress{width:100%;height:8px;background:#0b0b0b;border:1px solid #151619;border-radius:6px;overflow:hidden;}
.progress > div{height:100%;width:0%;background:linear-gradient(90deg,#3bd,#58a6ff);transition:width .1s linear;}
#status{text-align:center;margin-top:6px;font-size:.9rem;color:var(--muted);}
@media(max-width:640px){button,select{width:100%;font-size:.95rem;}}
</style>
</head>
<body>

<header>
<h1>AI Video Processor</h1>
<p class="lead">Load a video, choose an effect, process, and download your edited video.</p>
</header>

<main>
<section class="mediaBox">
  <div class="mediaInner">
    <input type="file" id="videoInput" accept="video/*">
    <video id="inputVideo" playsinline controls></video>
    <canvas id="processedCanvas"></canvas>
  </div>
</section>

<section class="controls">
  <select id="effectSelect" class="aux">
    <option value="remove">Background Removal</option>
    <option value="blur">Background Blur</option>
  </select>
  <button id="processBtn">Process Video</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="playBtn" disabled>Play</button>
  <button id="downloadBtn" disabled>Download</button>
</section>

<div class="progressWrap">
  <div class="progress"><div id="progressFill"></div></div>
</div>

<div id="status">Ready.</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
<script>
const videoInput = document.getElementById('videoInput');
const inputVideo = document.getElementById('inputVideo');
const canvas = document.getElementById('processedCanvas');
const ctx = canvas.getContext('2d');
const processBtn = document.getElementById('processBtn');
const pauseBtn = document.getElementById('pauseBtn');
const playBtn = document.getElementById('playBtn');
const downloadBtn = document.getElementById('downloadBtn');
const effectSelect = document.getElementById('effectSelect');
const progressFill = document.getElementById('progressFill');
const statusEl = document.getElementById('status');

let seg, processing=false, recorder=null, recordedBlobs=[];
let rafId=null;

// Load video
videoInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  inputVideo.src = URL.createObjectURL(f);
  inputVideo.load();
  inputVideo.onloadeddata = ()=>{
    canvas.width = inputVideo.videoWidth;
    canvas.height = inputVideo.videoHeight;
    statusEl.textContent = `Loaded: ${inputVideo.videoWidth}x${inputVideo.videoHeight}`;
    processBtn.disabled = false;
  };
});

// Initialize MediaPipe Segmentation
seg = new SelfieSegmentation({locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
seg.setOptions({modelSelection:1});
seg.onResults(results=>{
  const mask = results.segmentationMask;
  if(!mask) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(inputVideo,0,0,canvas.width,canvas.height);

  if(effectSelect.value==='remove'){
    ctx.save();
    ctx.globalCompositeOperation='destination-in';
    ctx.drawImage(mask,0,0,canvas.width,canvas.height);
    ctx.restore();
  } else if(effectSelect.value==='blur'){
    ctx.save();
    ctx.filter='blur(12px)';
    ctx.drawImage(inputVideo,0,0,canvas.width,canvas.height);
    ctx.globalCompositeOperation='destination-in';
    ctx.drawImage(mask,0,0,canvas.width,canvas.height);
    ctx.restore();
  }
});

// Process video
processBtn.addEventListener('click',async ()=>{
  if(!inputVideo.src) return;
  recordedBlobs=[];
  const stream = canvas.captureStream(25);
  recorder = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8'});
  recorder.ondataavailable=ev=>{ if(ev.data && ev.data.size) recordedBlobs.push(ev.data); };
  recorder.start(1000);
  processing=true;
  pauseBtn.disabled=false;
  playBtn.disabled=false;
  downloadBtn.disabled=true;
  statusEl.textContent='Processing...';

  inputVideo.currentTime=0;
  await inputVideo.play().catch(()=>{});
  processLoop();
});

// Live processing loop
function processLoop(){
  if(!processing) return;
  if(!inputVideo.paused && !inputVideo.ended){
    seg.send({image:inputVideo});
  }
  const pct = inputVideo.duration ? (inputVideo.currentTime/inputVideo.duration*100) : 0;
  progressFill.style.width = `${Math.min(100,pct)}%`;
  if(inputVideo.ended){
    processing=false;
    recorder.stop();
    downloadBtn.disabled=false;
    statusEl.textContent='Processing complete';
    cancelAnimationFrame(rafId);
    return;
  }
  rafId=requestAnimationFrame(processLoop);
}

// Pause / Play
pauseBtn.addEventListener('click',()=>{ inputVideo.pause(); });
playBtn.addEventListener('click',()=>{ inputVideo.play(); processLoop(); });

// Download
downloadBtn.addEventListener('click',()=>{
  if(recordedBlobs.length===0) return;
  const blob = new Blob(recordedBlobs,{type:'video/webm'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`processed_${Date.now()}.webm`;
  a.click();
  statusEl.textContent='Downloaded processed video';
});
</script>
</body>
</html>