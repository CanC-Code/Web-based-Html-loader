<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Video Layer Editor</title>
<link rel="stylesheet" href="style.css">
<style>
  body {
    margin:0; padding:12px;
    font-family:Inter, system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background:#0d1117; color:#c9d1d9; display:flex; flex-direction:column; align-items:center;
  }
  h1 { color:#58a6ff; margin:0 0 6px 0; }
  video, canvas { width:100%; max-width:820px; border-radius:10px; background:#000; display:block; margin-bottom:12px; }
  .controls { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:6px; }
  button, select, input[type="file"] {
    min-width:120px; flex:1 1 auto; padding:10px; border-radius:8px; border:none; cursor:pointer; font-weight:700;
    font-size:1rem; background:#238636; color:#fff;
  }
  button:disabled { background:#2f3338; cursor:not-allowed; opacity:0.7; }
  .progress { width:100%; height:8px; background:#0b0b0b; border-radius:6px; overflow:hidden; border:1px solid #151619; margin-bottom:6px; }
  .progress > div { height:100%; width:0%; background:linear-gradient(90deg,#3bd,#58a6ff); transition:width 0.12s linear; }
  #status { color:#8b949e; font-size:0.95rem; text-align:center; word-break:break-word; margin-bottom:12px; }
  @media(max-width:640px){
    button, select, input[type="file"]{ font-size:0.95rem; min-width:unset; width:100%; }
  }
</style>
</head>
<body>

<h1>AI Video Layer Editor</h1>

<input type="file" id="videoInput" accept="video/*">

<video id="inputVideo" playsinline controls></video>
<canvas id="outputCanvas" aria-label="Processed output"></canvas>

<div class="controls">
  <button id="startBtn">Start Processing</button>
  <button id="stopBtn" disabled>Stop</button>
  <button id="playBtn" disabled>Play</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="saveBtn" disabled>Save Video</button>
  <select id="modeSelect">
    <option value="human">Human only</option>
    <option value="motion">Motion</option>
    <option value="all">All objects</option>
  </select>
</div>

<div class="progress"><div id="progressFill"></div></div>
<div id="status">Ready.</div>

<script src="detector.js"></script>
<script>
const videoInput = document.getElementById('videoInput');
const inputVideo = document.getElementById('inputVideo');
const outCanvas = document.getElementById('outputCanvas');
const outCtx = outCanvas.getContext('2d');

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const saveBtn = document.getElementById('saveBtn');
const modeSelect = document.getElementById('modeSelect');
const progressFill = document.getElementById('progressFill');
const statusEl = document.getElementById('status');

let processing = false;
let frameQueue = [];
let recorder = null;
let recordedBlobs = [];
let pendingProcess = null;

function setStatus(s){ statusEl.textContent = s; }
function setProgress(p){ progressFill.style.width = `${Math.max(0, Math.min(100,p))}%`; }

videoInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  inputVideo.src = URL.createObjectURL(file);
  inputVideo.load();
  inputVideo.onloadeddata = () => {
    outCanvas.width = inputVideo.videoWidth;
    outCanvas.height = inputVideo.videoHeight;
    setStatus(`Loaded: ${inputVideo.videoWidth}x${inputVideo.videoHeight}`);
    setProgress(0);
    startBtn.disabled = false;
    stopBtn.disabled = true;
    saveBtn.disabled = true;
  };
});

startBtn.addEventListener('click', async ()=>{
  if(!inputVideo.src) { setStatus('Select a video first'); return; }
  startBtn.disabled = true;
  stopBtn.disabled = false;
  modeSelect.disabled = true;
  setStatus('Initializing detector...');
  await Detector.init({ mode: modeSelect.value });
  frameQueue = [];
  recordedBlobs = [];

  // Start recording
  const stream = outCanvas.captureStream(30);
  recorder = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8'});
  recorder.ondataavailable = ev=>{ if(ev.data && ev.data.size) recordedBlobs.push(ev.data); };
  recorder.start(500);

  processing = true;
  inputVideo.currentTime = 0;
  await inputVideo.play().catch(()=>{});
  processLoop();
});

stopBtn.addEventListener('click', ()=>{
  processing = false;
  startBtn.disabled = false;
  stopBtn.disabled = true;
  modeSelect.disabled = false;
  if(recorder && recorder.state==='recording') recorder.stop();
  saveBtn.disabled = recordedBlobs.length===0;
  playBtn.disabled = recordedBlobs.length===0;
  pauseBtn.disabled = true;
  setStatus('Processing stopped');
});

playBtn.addEventListener('click', ()=>{
  if(frameQueue.length>0) playProcessedVideo();
});

pauseBtn.addEventListener('click', ()=>{
  processing=false;
  setStatus('Playback paused');
});

saveBtn.addEventListener('click', ()=>{
  if(recordedBlobs.length===0){ setStatus('Nothing recorded'); return; }
  const blob = new Blob(recordedBlobs,{type:'video/webm'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=`processed_${Date.now()}.webm`; a.click();
  setStatus('Video saved');
});

async function processLoop(){
  if(!processing) return;
  outCtx.clearRect(0,0,outCanvas.width,outCanvas.height);
  outCtx.drawImage(inputVideo,0,0,outCanvas.width,outCanvas.height);

  if(!pendingProcess){
    const frame = outCtx.getImageData(0,0,outCanvas.width,outCanvas.height);
    pendingProcess = Detector.processFrame(frame, { mode: modeSelect.value })
      .then(mask=>{
        pendingProcess=null;
        if(mask){
          Detector.applyMask(outCtx, mask);
          frameQueue.push(outCtx.getImageData(0,0,outCanvas.width,outCanvas.height));
        }
      }).catch(err=>{ console.error(err); pendingProcess=null; });
  }

  if(inputVideo.duration && !isNaN(inputVideo.duration)){
    const pct = Math.min(100,(inputVideo.currentTime/inputVideo.duration)*100);
    setProgress(pct);
  }

  if(inputVideo.currentTime>=inputVideo.duration-0.05){
    processing=false;
    stopBtn.click();
    setStatus('Processing complete');
  } else {
    requestAnimationFrame(processLoop);
  }
}

// Playback function
function playProcessedVideo(){
  let idx=0;
  const fps=30;
  function renderFrame(){
    if(idx>=frameQueue.length) return;
    outCtx.putImageData(frameQueue[idx],0,0);
    idx++;
    setTimeout(renderFrame,1000/fps);
  }
  renderFrame();
}
</script>
</body>
</html>