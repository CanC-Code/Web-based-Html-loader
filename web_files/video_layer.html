<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Video Layer — AI Editor with Exclusion</title>
<link rel="stylesheet" href="style.css">
<style>
:root {
  --bg:#0d1117; --panel:#0f1720; --muted:#8b949e;
  --accent:#58a6ff; --btn:#238636;
}
html, body { height:100%; margin:0; padding:0; background:var(--bg); color:#c9d1d9; font-family:Inter, system-ui, sans-serif; display:flex; flex-direction:column; align-items:center; padding:12px; box-sizing:border-box; }
header { text-align:center; margin-bottom:8px; }
h1 { margin:0; color:var(--accent); font-size:1.2rem; }
p.lead { margin:4px 0 0 0; color:var(--muted); }
main { width:100%; max-width:900px; display:flex; flex-direction:column; gap:12px; }
.mediaBox { background:#07080a; border:1px solid #16181c; border-radius:12px; padding:10px; }
.mediaInner { display:flex; flex-direction:column; align-items:center; gap:10px; }
video, canvas { width:100%; max-width:840px; border-radius:10px; background:#000; }

.controls { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; background:#0b0d10; border-radius:10px; border:1px solid #111317; padding:10px; }
button, select, input[type=file] { background:var(--btn); color:#fff; border:none; border-radius:8px; padding:10px; font-weight:600; cursor:pointer; }
button:disabled { opacity:0.6; cursor:not-allowed; }
.aux { background:#111315; color:var(--muted); }
.progressWrap { width:100%; margin-top:8px; }
.progress { width:100%; height:8px; background:#0b0b0b; border:1px solid #151619; border-radius:6px; overflow:hidden; }
.progress > div { height:100%; width:0%; background:linear-gradient(90deg,#3bd,#58a6ff); transition:width .1s linear; }
#status { text-align:center; margin-top:6px; font-size:.9rem; color:var(--muted); }
@media(max-width:640px){ button, select { width:100%; font-size:.95rem; } }
</style>
</head>
<body>

<header>
  <h1>Video Layer — AI Editor</h1>
  <p class="lead">Load video, select effect, choose exclusions, then process and save.</p>
</header>

<main>
  <section class="mediaBox">
    <div class="mediaInner">
      <input id="videoInput" type="file" accept="video/*">
      <video id="inputVideo" controls playsinline></video>
      <canvas id="outputCanvas" aria-label="Processed output"></canvas>
    </div>
  </section>

  <section class="controls">
    <button id="processBtn">Process Video</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="playBtn" disabled>Play Result</button>
    <button id="downloadBtn" disabled>Download</button>
    <select id="effectSelect" class="aux">
      <option value="remove">Background Removal</option>
      <option value="blur">Background Blur</option>
    </select>
    <select id="excludeSelect" class="aux">
      <option value="none">Exclude: None</option>
      <option value="fan">Exclude: Fan</option>
    </select>
  </section>

  <div class="progressWrap">
    <div class="progress"><div id="progressFill"></div></div>
  </div>

  <div id="status">Ready.</div>
</main>

<script>
const videoInput = document.getElementById('videoInput');
const inputVideo = document.getElementById('inputVideo');
const outputCanvas = document.getElementById('outputCanvas');
const ctx = outputCanvas.getContext('2d');

const processBtn = document.getElementById('processBtn');
const stopBtn = document.getElementById('stopBtn');
const playBtn = document.getElementById('playBtn');
const downloadBtn = document.getElementById('downloadBtn');
const effectSelect = document.getElementById('effectSelect');
const excludeSelect = document.getElementById('excludeSelect');

const progressFill = document.getElementById('progressFill');
const statusEl = document.getElementById('status');

let processing = false;
let recordedBlobs = [];
let mediaRecorder = null;
let worker = null;

// Helper
function setStatus(text){ statusEl.textContent = text; }
function setProgress(p){ progressFill.style.width = `${Math.max(0,Math.min(100,p))}%`; }

// Video load
videoInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  inputVideo.src = URL.createObjectURL(file);
  inputVideo.load();
  inputVideo.onloadeddata = () => {
    outputCanvas.width = inputVideo.videoWidth;
    outputCanvas.height = inputVideo.videoHeight;
    setStatus(`Video loaded (${inputVideo.videoWidth}x${inputVideo.videoHeight})`);
    setProgress(0);
    processBtn.disabled = false;
    stopBtn.disabled = true;
    playBtn.disabled = true;
    downloadBtn.disabled = true;
  };
});

// Initialize worker
function initWorker(){
  if(worker) worker.terminate();
  worker = new Worker('detector-worker.js');
  worker.onmessage = (e)=>{
    const msg = e.data;
    if(msg.type === 'mask'){
      ctx.clearRect(0,0,outputCanvas.width,outputCanvas.height);
      ctx.drawImage(msg.mask,0,0,outputCanvas.width,outputCanvas.height);
    } else if(msg.type==='log'){
      console.log(msg.msg);
    }
  };
  worker.postMessage({type:'init'});
}

// Process loop
let rafId = null;
function processLoop(){
  if(!processing) return;
  ctx.drawImage(inputVideo,0,0,outputCanvas.width,outputCanvas.height);

  const frame = ctx.getImageData(0,0,outputCanvas.width,outputCanvas.height);

  worker.postMessage({
    type:'process',
    frame,
    width:outputCanvas.width,
    height:outputCanvas.height,
    effect:effectSelect.value,
    exclude:excludeSelect.value
  });

  setProgress((inputVideo.currentTime/inputVideo.duration)*100);

  rafId = requestAnimationFrame(processLoop);
}

// Buttons
processBtn.addEventListener('click', ()=>{
  if(!inputVideo.src) return;
  setStatus('Processing started...');
  processing = true;
  processBtn.disabled = true;
  stopBtn.disabled = false;
  playBtn.disabled = true;
  downloadBtn.disabled = true;

  recordedBlobs = [];
  const stream = outputCanvas.captureStream(25);
  mediaRecorder = new MediaRecorder(stream, { mimeType:'video/webm;codecs=vp8' });
  mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) recordedBlobs.push(e.data); };
  mediaRecorder.start();

  initWorker();
  inputVideo.currentTime = 0;
  inputVideo.play().catch(()=>{});
  processLoop();
});

stopBtn.addEventListener('click', ()=>{
  processing=false;
  cancelAnimationFrame(rafId);
  stopBtn.disabled=true;
  processBtn.disabled=false;
  playBtn.disabled=recordedBlobs.length>0?false:true;
  downloadBtn.disabled=recordedBlobs.length>0?false:true;
  inputVideo.pause();
  if(mediaRecorder && mediaRecorder.state==='recording') mediaRecorder.stop();
  setStatus('Processing stopped.');
});

playBtn.addEventListener('click', ()=>{
  if(recordedBlobs.length===0) return;
  const blob = new Blob(recordedBlobs,{type:'video/webm'});
  const url = URL.createObjectURL(blob);
  inputVideo.src = url;
  inputVideo.play();
  setStatus('Playing processed video');
});

downloadBtn.addEventListener('click', ()=>{
  if(recordedBlobs.length===0) return;
  const blob = new Blob(recordedBlobs,{type:'video/webm'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;
  a.download=`processed_${Date.now()}.webm`;
  a.click();
  setStatus('Video downloaded');
});
</script>
</body>
</html>