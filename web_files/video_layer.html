<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Video Background Removal â€” Worker</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
<h1>AI Video Background Removal</h1>
<p class="lead">Load video, select effect, process in the background, then play or download.</p>
</header>

<main>
<section class="mediaBox">
  <div class="mediaInner">
    <input id="videoInput" type="file" accept="video/*">
    <video id="inputVideo" playsinline controls></video>
    <canvas id="outputCanvas"></canvas>
  </div>
</section>

<section class="controls">
  <select id="effectSelect" class="aux">
    <option value="remove">Background Remove</option>
    <option value="blur">Background Blur</option>
  </select>
  <button id="processBtn">Process Video</button>
  <button id="playBtn" disabled>Play</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="downloadBtn" disabled>Download</button>
</section>

<div class="progressWrap">
  <div class="progress"><div id="progressFill"></div></div>
</div>
<div id="status">Ready.</div>
</main>

<script>
const videoInput = document.getElementById('videoInput');
const inputVideo = document.getElementById('inputVideo');
const outCanvas = document.getElementById('outputCanvas');
const outCtx = outCanvas.getContext('2d');

const processBtn = document.getElementById('processBtn');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const downloadBtn = document.getElementById('downloadBtn');
const effectSelect = document.getElementById('effectSelect');

const progressFill = document.getElementById('progressFill');
const statusEl = document.getElementById('status');

let processedFrames = [];
let worker = null;
let processing = false;

function setStatus(msg){statusEl.textContent=msg;}
function setProgress(p){progressFill.style.width=`${p}%`;}

// === VIDEO LOAD ===
videoInput.addEventListener('change', e=>{
  const file=e.target.files[0];
  if(!file) return;
  inputVideo.src=URL.createObjectURL(file);
  inputVideo.load();
  inputVideo.onloadeddata=()=>{
    outCanvas.width=inputVideo.videoWidth;
    outCanvas.height=inputVideo.videoHeight;
    setStatus('Video loaded.');
    setProgress(0);
    processBtn.disabled=false;
    playBtn.disabled=true;
    pauseBtn.disabled=true;
    downloadBtn.disabled=true;
    processedFrames=[];
  };
});

// === WORKER INIT ===
function initWorker(){
  return new Promise(res=>{
    worker = new Worker('detector-worker.js');
    worker.onmessage = e=>{
      const data = e.data;
      if(data.type==='ready') res();
      else if(data.type==='mask') applyMask(data.mask, data.effect);
    };
    worker.postMessage({ type:'init' });
  });
}

// === PROCESS VIDEO ===
processBtn.addEventListener('click', async ()=>{
  if(!inputVideo.src) return;
  processBtn.disabled=true;
  setStatus('Initializing worker...');
  await initWorker();
  setStatus('Processing video...');
  processedFrames=[];
  inputVideo.currentTime=0;
  await inputVideo.play().catch(()=>{});

  const totalFrames = Math.floor(inputVideo.duration*25);
  let frameIndex=0;
  processing=true;

  function processFrame(){
    if(inputVideo.paused || inputVideo.ended || !processing){
      finishProcessing();
      return;
    }

    outCtx.drawImage(inputVideo,0,0,outCanvas.width,outCanvas.height);
    const frame=outCtx.getImageData(0,0,outCanvas.width,outCanvas.height);
    worker.postMessage({
      type:'process',
      frame,
      width:outCanvas.width,
      height:outCanvas.height,
      effect:effectSelect.value
    });

    processedFrames.push(frame);
    frameIndex++;
    setProgress(Math.floor((frameIndex/totalFrames)*100));

    requestAnimationFrame(processFrame);
  }

  processFrame();
});

// === APPLY MASK ===
function applyMask(maskImg, effect){
  // maskImg is an ImageBitmap from worker
  const tempCanvas=document.createElement('canvas');
  tempCanvas.width=outCanvas.width;
  tempCanvas.height=outCanvas.height;
  const tempCtx=tempCanvas.getContext('2d');
  tempCtx.putImageData(processedFrames[processedFrames.length-1],0,0);

  outCtx.clearRect(0,0,outCanvas.width,outCanvas.height);

  if(effect==='remove'){
    outCtx.drawImage(tempCanvas,0,0);
    outCtx.globalCompositeOperation='destination-in';
    outCtx.drawImage(maskImg,0,0,outCanvas.width,outCanvas.height);
    outCtx.globalCompositeOperation='source-over';
  }else if(effect==='blur'){
    outCtx.save();
    outCtx.filter='blur(10px)';
    outCtx.globalCompositeOperation='destination-over';
    outCtx.drawImage(tempCanvas,0,0);
    outCtx.restore();

    outCtx.globalCompositeOperation='destination-in';
    outCtx.drawImage(maskImg,0,0,outCanvas.width,outCanvas.height);
    outCtx.globalCompositeOperation='source-over';
  }
}

// === FINISH PROCESSING ===
function finishProcessing(){
  processing=false;
  setStatus('Processing complete.');
  playBtn.disabled=false;
  pauseBtn.disabled=false;
  downloadBtn.disabled=false;
  inputVideo.pause();
  inputVideo.currentTime=0;
}

// === PLAYBACK ===
let playIndex=0, playInterval=null;
playBtn.addEventListener('click',()=>{
  if(processedFrames.length===0) return;
  clearInterval(playInterval);
  playIndex=0;
  playInterval=setInterval(()=>{
    outCtx.putImageData(processedFrames[playIndex],0,0);
    playIndex++;
    if(playIndex>=processedFrames.length) clearInterval(playInterval);
  },40);
});
pauseBtn.addEventListener('click',()=>clearInterval(playInterval));

// === DOWNLOAD ===
downloadBtn.addEventListener('click',()=>{
  const stream=outCanvas.captureStream(25);
  const recorder=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8'});
  const chunks=[];
  recorder.ondataavailable=e=>{if(e.data.size) chunks.push(e.data);}
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:'video/webm'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=`processed_${Date.now()}.webm`;
    a.click();
    setStatus('Downloaded processed video.');
  };
  recorder.start();
  setTimeout(()=>recorder.stop(),processedFrames.length*40);
});
</script>
</body>
</html>