<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Video Processor</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.min.js"></script>
</head>
<body>
<header>
  <h1>AI Video Processor</h1>
  <p class="lead">Automatic background removal, preview, feedback, and download.</p>
</header>

<main>
  <div class="mediaBox">
    <div class="mediaInner">
      <input type="file" id="videoInput" accept="video/*">
      <video id="inputVideo" controls></video>
      <canvas id="outputCanvas"></canvas>
      <video id="previewVideo" controls style="display:none"></video>
    </div>
  </div>

  <div class="controls">
    <select id="modeSelect">
      <option value="remove">Remove Background</option>
      <option value="blur">Blur Background</option>
    </select>
    <button id="processBtn">Process</button>
    <button id="likeBtn">👍 Like</button>
    <button id="dislikeBtn">👎 Dislike</button>
    <button id="regenerateBtn">Regenerate</button>
    <button id="saveBtn">💾 Download</button>
  </div>

  <div class="progressWrap">
    <div class="progress"><div></div></div>
  </div>
  <p id="status">Ready.</p>
</main>

<script>
const videoInput = document.getElementById("videoInput");
const inputVideo = document.getElementById("inputVideo");
const outputCanvas = document.getElementById("outputCanvas");
const previewVideo = document.getElementById("previewVideo");
const ctx = outputCanvas.getContext("2d");
const processBtn = document.getElementById("processBtn");
const saveBtn = document.getElementById("saveBtn");
const likeBtn = document.getElementById("likeBtn");
const dislikeBtn = document.getElementById("dislikeBtn");
const regenerateBtn = document.getElementById("regenerateBtn");
const progressBar = document.querySelector(".progress > div");
const statusEl = document.getElementById("status");
const modeSelect = document.getElementById("modeSelect");

let segmentation = null;
let processing = false;
let recordedChunks = [];
let recorder = null;

function setStatus(msg){ statusEl.textContent = msg; }
function setProgress(pct){ progressBar.style.width = pct + "%"; }

videoInput.addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  inputVideo.src = url;
  inputVideo.load();
  setStatus("Video loaded, ready to process.");
});

function initSegmentation(){
  segmentation = new SelfieSegmentation.SelfieSegmentation({locateFile:(f)=>
    `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
  });
  segmentation.setOptions({ modelSelection:1 });
  segmentation.onResults(results=>{
    if(!processing) return;
    renderFrame(results);
  });
}

function renderFrame(results){
  const w = outputCanvas.width;
  const h = outputCanvas.height;
  ctx.save();
  ctx.clearRect(0,0,w,h);
  if(results.segmentationMask){
    ctx.drawImage(results.segmentationMask,0,0,w,h);
    ctx.globalCompositeOperation="source-in";
    ctx.drawImage(inputVideo,0,0,w,h);
    ctx.globalCompositeOperation="destination-over";
    if(modeSelect.value==="blur"){
      ctx.filter="blur(10px)";
      ctx.drawImage(inputVideo,0,0,w,h);
      ctx.filter="none";
    } else {
      ctx.fillStyle="#000";
      ctx.fillRect(0,0,w,h);
    }
  } else {
    ctx.drawImage(inputVideo,0,0,w,h);
  }
  ctx.restore();
}

async function processVideo(){
  if(!inputVideo.src){ setStatus("Load a video first."); return; }

  processing = true;
  setStatus("Processing video...");
  recordedChunks=[];
  outputCanvas.width = inputVideo.videoWidth;
  outputCanvas.height = inputVideo.videoHeight;

  // Recorder for processed output
  const stream = outputCanvas.captureStream(30);
  recorder = new MediaRecorder(stream,{mimeType:"video/webm"});
  recorder.ondataavailable = e=>recordedChunks.push(e.data);
  recorder.start();

  inputVideo.play();

  async function loop(){
    if(!processing) return;
    await segmentation.send({image:inputVideo});
    const pct = (inputVideo.currentTime / inputVideo.duration) * 100;
    setProgress(pct);
    if(!inputVideo.paused && !inputVideo.ended) requestAnimationFrame(loop);
    else finishProcess();
  }
  requestAnimationFrame(loop);
}

function finishProcess(){
  processing = false;
  setStatus("Processing complete, finalizing...");
  recorder.stop();
  recorder.onstop = ()=>{
    const blob = new Blob(recordedChunks,{type:"video/webm"});
    const url = URL.createObjectURL(blob);
    previewVideo.src = url;
    previewVideo.style.display="block";
    previewVideo.load();
    previewVideo.play();
    setStatus("Preview ready — you can replay or download.");
  };
}

saveBtn.addEventListener("click", ()=>{
  if(recordedChunks.length===0){ setStatus("No video to save."); return; }
  const blob = new Blob(recordedChunks,{type:"video/webm"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`processed_${Date.now()}.webm`;
  a.click();
  setStatus("Video saved.");
});

likeBtn.addEventListener("click", ()=>setStatus("Feedback: 👍"));
dislikeBtn.addEventListener("click", ()=>setStatus("Feedback: 👎"));
regenerateBtn.addEventListener("click", ()=>{
  setStatus("Regenerating new variant...");
  processVideo();
});

processBtn.addEventListener("click", processVideo);

initSegmentation();
</script>
</body>
</html>