<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Video Editor — Background Removal</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>AI Video Editor — Background Removal</h1>
  <p class="lead">Load video, select mode, preview processed video, then download.</p>
</header>

<main>
  <section class="mediaBox">
    <div class="mediaInner">
      <input type="file" id="videoInput" accept="video/*">
      <video id="inputVideo" playsinline controls></video>
      <canvas id="outputCanvas" aria-label="Processed output"></canvas>
    </div>
  </section>

  <section class="controls">
    <select id="modeSelect" class="aux">
      <option value="remove">Remove Background</option>
      <option value="blur">Background Blur</option>
      <option value="original">Original</option>
    </select>
    <button id="playBtn">Play Processed</button>
    <button id="pauseBtn">Pause</button>
    <button id="saveBtn">Download</button>
  </section>

  <div class="progressWrap">
    <div class="progress"><div id="progressFill"></div></div>
  </div>

  <div id="status">Ready.</div>
</main>

<script src="detector.js"></script>
<script>
const inputVideo = document.getElementById("inputVideo");
const videoInput = document.getElementById("videoInput");
const outCanvas = document.getElementById("outputCanvas");
const outCtx = outCanvas.getContext("2d");

const playBtn = document.getElementById("playBtn");
const pauseBtn = document.getElementById("pauseBtn");
const saveBtn = document.getElementById("saveBtn");
const modeSelect = document.getElementById("modeSelect");

const progressFill = document.getElementById("progressFill");
const statusEl = document.getElementById("status");

let processing = false;
let recorder = null;
let recordedBlobs = [];

// --- Load video ---
videoInput.addEventListener("change", e => {
  const f = e.target.files[0];
  if(!f) return;
  inputVideo.src = URL.createObjectURL(f);
  inputVideo.load();
  inputVideo.onloadeddata = () => {
    outCanvas.width = inputVideo.videoWidth;
    outCanvas.height = inputVideo.videoHeight;
    recordedBlobs = [];
    setStatus("Video loaded.");
    startProcessing();
  };
});

// --- Status helpers ---
function setStatus(msg){ statusEl.textContent = msg; }
function setProgress(p){ progressFill.style.width = `${p}%`; }

// --- Processing loop ---
async function startProcessing() {
  if(!DetectorInstance.ready) {
    setStatus("Waiting for AI detector...");
    await new Promise(r => {
      const checkReady = setInterval(()=>{
        if(DetectorInstance.ready){ clearInterval(checkReady); r(); }
      },100);
    });
  }

  processing = true;
  inputVideo.currentTime = 0;
  inputVideo.play().catch(()=>{});

  if(recorder) recorder.stop();
  recordedBlobs = [];
  const stream = outCanvas.captureStream(25);
  recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8' });
  recorder.ondataavailable = e => { if(e.data && e.data.size) recordedBlobs.push(e.data); };
  recorder.start(1000);

  const processFrameLoop = async () => {
    if(!processing) return;
    outCtx.clearRect(0,0,outCanvas.width,outCanvas.height);
    outCtx.drawImage(inputVideo,0,0,outCanvas.width,outCanvas.height);

    const mask = await DetectorInstance.processFrame(inputVideo,outCanvas.width,outCanvas.height,modeSelect.value);
    if(mask) DetectorInstance.applyMask(outCtx, mask,outCanvas.width,outCanvas.height,modeSelect.value);

    if(inputVideo.duration) setProgress((inputVideo.currentTime/inputVideo.duration)*100);
    requestAnimationFrame(processFrameLoop);
  };

  processFrameLoop();
}

// --- Playback buttons ---
playBtn.onclick = ()=>{ inputVideo.play(); processing=true; startProcessing(); };
pauseBtn.onclick = ()=>{ inputVideo.pause(); processing=false; };

// --- Download ---
saveBtn.onclick = () => {
  if(recordedBlobs.length===0){ setStatus("Nothing recorded yet."); return; }
  const blob = new Blob(recordedBlobs,{ type:'video/webm' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `processed_${Date.now()}.webm`;
  a.click();
  setStatus("Video downloaded.");
};
</script>
</body>
</html>