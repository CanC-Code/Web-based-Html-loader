<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Video Editor — Background Removal/Blur</title>
<link rel="stylesheet" href="style.css">
<style>
:root {
  --bg:#0d1117; --panel:#0f1720; --muted:#8b949e; --accent:#58a6ff; --btn:#238636;
}
html, body { height:100%; margin:0; font-family:Inter, system-ui, -apple-system; background:var(--bg); color:#c9d1d9; display:flex; flex-direction:column; align-items:center; padding:12px; box-sizing:border-box; }

header { width:100%; max-width:920px; margin-bottom:8px; text-align:center; }
h1 { margin:0; color:var(--accent); font-size:1.2rem; }
p.lead { margin:6px 0 0 0; color:var(--muted); font-size:0.95rem; }

main { width:100%; max-width:920px; display:flex; flex-direction:column; gap:12px; }

.mediaBox { background:#07080a; border:1px solid #16181c; border-radius:12px; padding:10px; }
.mediaInner { display:flex; flex-direction:column; gap:10px; align-items:center; }

video, canvas {
  width:100%; max-width:820px; border-radius:10px; background:#000; display:block;
}

.controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; padding:10px; border-radius:10px; background:linear-gradient(180deg,#0b0d10,#071013); border:1px solid #111317; }
.controls > * { min-width:120px; flex:1 1 auto; }
button, select, input[type="file"] {
  appearance:none; -webkit-appearance:none; background:var(--btn); color:#fff; border:none; padding:10px 12px; border-radius:8px; font-weight:700; cursor:pointer; font-size:1rem;
}
button:disabled { background:#2f3338; opacity:0.7; cursor:not-allowed; }

.progressWrap { width:100%; margin-top:8px; }
.progress { width:100%; height:8px; background:#0b0b0b; border-radius:6px; overflow:hidden; border:1px solid #151619; }
.progress > div { height:100%; width:0%; background:linear-gradient(90deg,#3bd, #58a6ff); transition:width 0.12s linear; }

#status { margin-top:10px; color:var(--muted); font-size:0.95rem; text-align:center; word-break:break-word; }

@media(max-width:640px){
  .controls { gap:6px; }
  button, select, input[type="file"] { font-size:0.95rem; padding:10px; min-width:unset; width:100%; }
}
</style>
</head>
<body>
<header>
  <h1>AI Video Editor</h1>
  <p class="lead">Load a video, select a mode, preview edits, then download.</p>
</header>

<main>
  <section class="mediaBox">
    <div class="mediaInner">
      <input id="videoInput" type="file" accept="video/*">
      <video id="inputVideo" playsinline controls></video>
      <canvas id="outputCanvas" aria-label="Processed output"></canvas>
    </div>
  </section>

  <section class="controls">
    <select id="modeSelect">
      <option value="human">Remove Background</option>
      <option value="blur">Blur Background</option>
      <option value="motion">Motion Detection</option>
      <option value="all">Edge Detection</option>
    </select>
    <button id="startBtn">Start Processing</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="playBtn" disabled>Play</button>
    <button id="downloadBtn" disabled>Download</button>
  </section>

  <div class="progressWrap">
    <div class="progress"><div id="progressFill"></div></div>
  </div>

  <div id="status">Ready.</div>
</main>

<script src="detector.js"></script>
<script>
const videoInput = document.getElementById('videoInput');
const inputVideo = document.getElementById('inputVideo');
const outCanvas = document.getElementById('outputCanvas');
const outCtx = outCanvas.getContext('2d');

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const playBtn = document.getElementById('playBtn');
const downloadBtn = document.getElementById('downloadBtn');
const modeSelect = document.getElementById('modeSelect');

const progressFill = document.getElementById('progressFill');
const statusEl = document.getElementById('status');

let processing = false;
let pendingProcess = null;
let recordedBlobs = [];
let recorder = null;

// --- helpers ---
function setStatus(msg){ statusEl.textContent = msg; }
function setProgress(p){ progressFill.style.width = `${Math.max(0,Math.min(100,p))}%`; }

// --- load video ---
videoInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  inputVideo.src = URL.createObjectURL(file);
  inputVideo.load();
  inputVideo.onloadeddata = () => {
    outCanvas.width = inputVideo.videoWidth;
    outCanvas.height = inputVideo.videoHeight;
    setStatus(`Loaded ${inputVideo.videoWidth}×${inputVideo.videoHeight}`);
    startBtn.disabled = false;
    stopBtn.disabled = true;
    playBtn.disabled = true;
    downloadBtn.disabled = true;
    recordedBlobs = [];
  };
});

// --- start processing ---
startBtn.onclick = async () => {
  if(!inputVideo.src) { setStatus("Load a video first."); return; }
  startBtn.disabled = true;
  stopBtn.disabled = false;
  modeSelect.disabled = true;

  setStatus("Initializing detector...");
  try {
    await Detector.init({ mode: modeSelect.value });
  } catch(err){
    console.error(err);
    setStatus("Detector init failed: " + err.message);
    startBtn.disabled = false; stopBtn.disabled = true; modeSelect.disabled = false;
    return;
  }

  recordedBlobs = [];
  const stream = outCanvas.captureStream(25);
  recorder = new MediaRecorder(stream, { mimeType:'video/webm;codecs=vp8' });
  recorder.ondataavailable = e=>{ if(e.data && e.data.size) recordedBlobs.push(e.data); };
  recorder.start(1000);

  processing = true;
  inputVideo.currentTime = 0;
  inputVideo.play().catch(()=>{});
  setStatus("Processing...");

  processLoop();
};

// --- stop processing ---
stopBtn.onclick = () => {
  processing = false;
  startBtn.disabled = false;
  stopBtn.disabled = true;
  modeSelect.disabled = false;

  if(recorder && recorder.state==="recording") recorder.stop();
  playBtn.disabled = recordedBlobs.length===0;
  downloadBtn.disabled = recordedBlobs.length===0;
  setStatus("Processing stopped.");
};

// --- play processed video ---
playBtn.onclick = () => {
  if(recordedBlobs.length===0) return;
  const blob = new Blob(recordedBlobs, {type:'video/webm'});
  const url = URL.createObjectURL(blob);
  inputVideo.src = url;
  inputVideo.play().catch(()=>{});
};

// --- download processed video ---
downloadBtn.onclick = () => {
  if(recordedBlobs.length===0) return;
  const blob = new Blob(recordedBlobs, {type:'video/webm'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `processed_${Date.now()}.webm`;
  a.click();
  setStatus("Video downloaded.");
};

// --- processing loop ---
let lastTs = 0;
const targetMs = 100;

async function processLoop(ts){
  if(!processing) return;

  outCtx.clearRect(0,0,outCanvas.width,outCanvas.height);
  outCtx.drawImage(inputVideo,0,0,outCanvas.width,outCanvas.height);

  if(performance.now()-lastTs >= targetMs && !pendingProcess){
    lastTs = performance.now();
    const frame = outCtx.getImageData(0,0,outCanvas.width,outCanvas.height);
    pendingProcess = Detector.processFrame(frame, {mode:modeSelect.value})
      .then(mask => {
        pendingProcess=null;
        if(mask) Detector.applyMask(outCtx, mask);
      })
      .catch(err=>{ console.error(err); pendingProcess=null; });
  }

  if(inputVideo.duration && inputVideo.duration>0){
    setProgress(Math.min(100, (inputVideo.currentTime/inputVideo.duration)*100));
    if(inputVideo.currentTime>=inputVideo.duration-0.05){
      stopBtn.click(); // auto stop at end
    }
  }

  requestAnimationFrame(processLoop);
}

window.addEventListener('beforeunload', e=>{
  if(processing){ e.preventDefault(); e.returnValue=''; }
});

</script>
</body>
</html>