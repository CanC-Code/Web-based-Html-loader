<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Video Background Removal</title>
<link rel="stylesheet" href="style.css">
<style>
:root {
  --bg:#0d1117; --panel:#0f1720; --muted:#8b949e;
  --accent:#58a6ff; --btn:#238636;
}
html,body{height:100%;margin:0;padding:0;background:var(--bg);color:#c9d1d9;font-family:Inter,sans-serif;display:flex;flex-direction:column;align-items:center;padding:12px;box-sizing:border-box;}
header{text-align:center;margin-bottom:8px;}
h1{margin:0;color:var(--accent);font-size:1.1rem;}
p.lead{margin:4px 0 0 0;color:var(--muted);}
main{width:100%;max-width:900px;display:flex;flex-direction:column;gap:12px;}
.mediaBox{background:#07080a;border:1px solid #16181c;border-radius:12px;padding:10px;}
.mediaInner{display:flex;flex-direction:column;align-items:center;gap:10px;}
video,canvas{width:100%;max-width:840px;border-radius:10px;background:#000;}
.controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;background:#0b0d10;border-radius:10px;border:1px solid #111317;padding:10px;}
button,select,input[type=file]{background:var(--btn);color:#fff;border:none;border-radius:8px;padding:10px;font-weight:600;cursor:pointer;}
button:disabled{opacity:0.6;cursor:not-allowed;}
.aux{background:#111315;color:var(--muted);}
.progressWrap{width:100%;margin-top:8px;}
.progress{width:100%;height:8px;background:#0b0b0b;border:1px solid #151619;border-radius:6px;overflow:hidden;}
.progress>div{height:100%;width:0%;background:linear-gradient(90deg,#3bd,#58a6ff);transition:width .1s linear;}
#status{text-align:center;margin-top:6px;font-size:.9rem;color:var(--muted);}
@media(max-width:640px){button,select{width:100%;font-size:.95rem;}}
</style>
</head>
<body>

<header>
<h1>AI Video Background Removal</h1>
<p class="lead">Load a video, start processing, then replay or download the final result. Unwanted objects (like fans) are excluded.</p>
</header>

<main>
<section class="mediaBox">
  <div class="mediaInner">
    <input id="videoInput" type="file" accept="video/*">
    <video id="inputVideo" playsinline controls></video>
    <canvas id="outputCanvas"></canvas>
  </div>
</section>

<section class="controls">
  <button id="processBtn">Process Video</button>
  <button id="playBtn" disabled>Play</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="downloadBtn" disabled>Download</button>
  <select id="effectSelect" class="aux">
    <option value="remove">Background Remove</option>
    <option value="blur">Background Blur</option>
  </select>
</section>

<div class="progressWrap">
  <div class="progress"><div id="progressFill"></div></div>
</div>

<div id="status">Ready.</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<script>
// === ELEMENTS ===
const videoInput = document.getElementById('videoInput');
const inputVideo = document.getElementById('inputVideo');
const outCanvas = document.getElementById('outputCanvas');
const outCtx = outCanvas.getContext('2d');

const processBtn = document.getElementById('processBtn');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const downloadBtn = document.getElementById('downloadBtn');
const effectSelect = document.getElementById('effectSelect');

const progressFill = document.getElementById('progressFill');
const statusEl = document.getElementById('status');

// === VARIABLES ===
let seg = null;
let mask = null;
let processedFrames = [];
let recording = false;
let mediaRecorder = null;

// === HELPERS ===
function setStatus(msg){statusEl.textContent = msg;}
function setProgress(p){progressFill.style.width = `${p}%`;}
function clearFrames(){processedFrames=[];}

// === LOAD VIDEO ===
videoInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  inputVideo.src = URL.createObjectURL(f);
  inputVideo.load();
  inputVideo.onloadeddata = ()=>{
    outCanvas.width = inputVideo.videoWidth;
    outCanvas.height = inputVideo.videoHeight;
    setStatus('Video loaded.');
    setProgress(0);
    processBtn.disabled=false;
    playBtn.disabled=true;
    pauseBtn.disabled=true;
    downloadBtn.disabled=true;
    clearFrames();
  };
});

// === INIT SEGMENTATION ===
seg = new SelfieSegmentation({locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
seg.setOptions({modelSelection:1});
seg.onResults(results=>{
  mask = results.segmentationMask;
});

// === PROCESS VIDEO ===
processBtn.addEventListener('click', async ()=>{
  if(!inputVideo.src) return;
  processBtn.disabled=true;
  setStatus('Processing...');
  clearFrames();

  inputVideo.currentTime = 0;
  await inputVideo.play().catch(()=>{});

  const totalFrames = Math.floor(inputVideo.duration * 25); // assuming 25fps
  let frameIndex=0;

  function processFrame(){
    if(inputVideo.paused || inputVideo.ended) return finishProcessing();
    // draw input frame
    outCtx.drawImage(inputVideo,0,0,outCanvas.width,outCanvas.height);
    const frame = outCtx.getImageData(0,0,outCanvas.width,outCanvas.height);

    // send to Mediapipe
    seg.send({image:inputVideo});

    if(mask){
      // apply mask
      const tempCanvas=document.createElement('canvas');
      tempCanvas.width=outCanvas.width;
      tempCanvas.height=outCanvas.height;
      const tempCtx=tempCanvas.getContext('2d');
      tempCtx.putImageData(frame,0,0);

      outCtx.clearRect(0,0,outCanvas.width,outCanvas.height);

      if(effectSelect.value==='remove'){
        // only keep people, remove background
        outCtx.drawImage(tempCanvas,0,0);
        outCtx.globalCompositeOperation='destination-in';
        outCtx.drawImage(mask,0,0,outCanvas.width,outCanvas.height);
        outCtx.globalCompositeOperation='source-over';
      }else if(effectSelect.value==='blur'){
        // blur background
        outCtx.save();
        outCtx.filter='blur(10px)';
        outCtx.globalCompositeOperation='destination-over';
        outCtx.drawImage(tempCanvas,0,0);
        outCtx.restore();

        outCtx.globalCompositeOperation='destination-in';
        outCtx.drawImage(mask,0,0,outCanvas.width,outCanvas.height);
        outCtx.globalCompositeOperation='source-over';
      }
    }

    // save processed frame
    processedFrames.push(outCanvas.toDataURL('image/webp'));

    frameIndex++;
    setProgress(Math.floor((frameIndex/totalFrames)*100));

    requestAnimationFrame(processFrame);
  }

  processFrame();
});

function finishProcessing(){
  setStatus('Processing complete.');
  playBtn.disabled=false;
  pauseBtn.disabled=false;
  downloadBtn.disabled=false;
  inputVideo.pause();
  inputVideo.currentTime=0;
}

// === PLAYBACK PROCESSED ===
let playIndex=0;
let playInterval=null;
playBtn.addEventListener('click', ()=>{
  if(processedFrames.length===0) return;
  clearInterval(playInterval);
  playIndex=0;
  playInterval=setInterval(()=>{
    outCtx.clearRect(0,0,outCanvas.width,outCanvas.height);
    const img=new Image();
    img.src=processedFrames[playIndex];
    img.onload=()=>outCtx.drawImage(img,0,0,outCanvas.width,outCanvas.height);
    playIndex++;
    if(playIndex>=processedFrames.length){clearInterval(playInterval);}
  },40); // 25 fps
});

pauseBtn.addEventListener('click', ()=>{
  clearInterval(playInterval);
});

// === DOWNLOAD ===
downloadBtn.addEventListener('click', ()=>{
  if(processedFrames.length===0) return;
  const videoStream=outCanvas.captureStream(25);
  const recorder=new MediaRecorder(videoStream,{mimeType:'video/webm;codecs=vp8'});
  const chunks=[];
  recorder.ondataavailable=e=>{if(e.data.size) chunks.push(e.data);};
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:'video/webm'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=`processed_${Date.now()}.webm`;
    a.click();
    setStatus('Downloaded processed video.');
  };
  recorder.start();
  let i=0;
  const interval=setInterval(()=>{
    const img=new Image();
    img.src=processedFrames[i];
    img.onload=()=>{
      outCtx.clearRect(0,0,outCanvas.width,outCanvas.height);
      outCtx.drawImage(img,0,0,outCanvas.width,outCanvas.height);
    };
    i++;
    if(i>=processedFrames.length){clearInterval(interval);recorder.stop();}
  },40);
});
</script>

</body>
</html>