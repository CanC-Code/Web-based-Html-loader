<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Video Layer — Live AI Editing</title>
<style>
  :root{--bg:#0d1117;--panel:#0f1720;--muted:#8b949e;--accent:#58a6ff;}
  body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#c9d1d9;display:flex;flex-direction:column;align-items:center;padding:1rem;}
  h1{color:var(--accent);margin:0 0 .75rem 0;font-size:1.2rem;}
  .topbar{display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;justify-content:center;margin-bottom:.75rem;width:100%;max-width:1100px;}
  .control,input[type=file]{background:var(--panel);color:inherit;border:1px solid #21262d;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;}
  #layout{display:grid;grid-template-columns:1fr 320px;gap:14px;width:100%;max-width:1100px;align-items:start;}
  #viewer{position:relative;background:#000;border-radius:10px;overflow:hidden;}
  video,canvas{display:block;width:100%;height:auto;max-width:100%;}
  #mainCanvas{position:absolute;left:0;top:0;}
  #sidebar{background:var(--panel);padding:12px;border-radius:10px;min-height:320px;color:#c9d1d9;}
  .section{margin-bottom:12px;}
  label{display:block;font-size:0.85rem;color:var(--muted);margin-bottom:6px;}
  #progressBar{width:100%;height:14px;background:#21262d;border-radius:6px;overflow:hidden;margin-top:4px;}
  #progressFill{height:100%;width:0%;background:var(--accent);}
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/deeplab@0.2.2/dist/deeplab.min.js"></script>
</head>
<body>
<h1>Video Layer — Live AI Editing</h1>

<div class="topbar">
  <input id="videoInput" type="file" accept="video/*" class="control">
  <button id="toggleDepth" class="control">Toggle Depth Grid</button>
  <button id="exportBtn" class="control" disabled>Export Video</button>
</div>

<div id="layout">
  <div id="viewer">
    <video id="video" playsinline controls></video>
    <canvas id="mainCanvas"></canvas>
  </div>
  <aside id="sidebar">
    <div class="section">
      <label>Processing Progress</label>
      <div id="progressBar"><div id="progressFill"></div></div>
    </div>
    <div class="section">
      <label>Depth Grid</label>
      <input id="depthScale" type="range" min="1" max="20" value="8">
    </div>
    <div id="status">Waiting for video...</div>
  </aside>
</div>

<script>
const videoInput = document.getElementById('videoInput');
const video = document.getElementById('video');
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');

const toggleDepthBtn = document.getElementById('toggleDepth');
const exportBtn = document.getElementById('exportBtn');
const depthScaleInput = document.getElementById('depthScale');
const statusEl = document.getElementById('status');
const progressFill = document.getElementById('progressFill');

let maskCanvas = document.createElement('canvas');
let maskCtx = maskCanvas.getContext('2d');

let deeplabModel = null;
let segMap = null;
let showDepthGrid = false;
let depthScale = parseInt(depthScaleInput.value,10);
let processing = false;

// Load model automatically
async function loadModel(){
  setStatus('Loading DeepLab model...');
  deeplabModel = await deeplab.load({ base:'ade20k', quantizationBytes:2 });
  setStatus('Model loaded. Ready for AI editing.');
}
loadModel();

// Video load
videoInput.addEventListener('change',()=>{
  const file = videoInput.files[0];
  if(!file) return;
  video.src = URL.createObjectURL(file);
  video.load();
  video.onloadeddata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    maskCanvas.width = 256;
    maskCanvas.height = 256;
    exportBtn.disabled = false;
    startDrawLoop();
    startSegmentationLoop();
    setStatus(`Video loaded (${video.videoWidth}×${video.videoHeight})`);
  };
});

// Live draw loop
function startDrawLoop(){
  function loop(){
    drawFrame();
    requestAnimationFrame(loop);
  }
  loop();
}

function drawFrame(){
  if(video.readyState<2) return;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  if(segMap){
    const scaleX = canvas.width/256;
    const scaleY = canvas.height/256;
    const imgData = maskCtx.createImageData(256,256);
    for(let i=0;i<256*256;i++){
      const cid = segMap[i];
      // highlight person/animal
      if(cid === 15 || cid === 16){ 
        const off = i*4;
        imgData.data[off] = 255;
        imgData.data[off+1] = 0;
        imgData.data[off+2] = 0;
        imgData.data[off+3] = 120;
      }
    }
    maskCtx.putImageData(imgData,0,0);
    ctx.drawImage(maskCanvas,0,0,canvas.width,canvas.height);
  }

  if(showDepthGrid) drawDepthGrid();
}

// Depth grid
function drawDepthGrid(){
  const w = canvas.width;
  const h = canvas.height;
  const zones = 20;
  ctx.save();
  ctx.globalAlpha = 0.2;
  for(let z=0;z<zones;z++){
    const fy = 1-(z/(zones-1));
    const y = Math.round((1-fy)*h);
    ctx.fillStyle = `hsl(${(z*18)%360} 60% ${60 - z*1}%)`;
    ctx.fillRect(0,y,w,h/zones);
  }
  ctx.restore();
}

// Toggle depth
toggleDepthBtn.addEventListener('click',()=>{
  showDepthGrid = !showDepthGrid;
  toggleDepthBtn.textContent = showDepthGrid?'Depth: ON':'Toggle Depth Grid';
});

// Depth scale
depthScaleInput.addEventListener('input',e=>depthScale=parseInt(e.target.value,10));

// Segmentation loop
async function startSegmentationLoop(){
  if(!deeplabModel) return;
  while(!video.paused && !video.ended){
    processing = true;
    updateProgress(0);
    const off = document.createElement('canvas');
    off.width = 256; off.height = 256;
    const offCtx = off.getContext('2d');
    offCtx.drawImage(video,0,0,256,256);
    const seg = await deeplabModel.segment(off);
    segMap = seg.segmentationMap;
    processing = false;
    updateProgress(100);
    await new Promise(r=>setTimeout(r,200));
  }
}

// Progress meter
function updateProgress(p){
  progressFill.style.width = p+'%';
  statusEl.textContent = processing?'Processing frame...':'Idle';
}
</script>
</body>
</html>
