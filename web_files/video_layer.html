<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Smart Background Editor</title>
<style>
  body {
    margin: 0;
    background: #0d1117;
    color: #c9d1d9;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1em;
  }

  h1 {
    font-size: 1.3em;
    margin-bottom: 0.8em;
    text-align: center;
  }

  #controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.5em;
    margin-bottom: 1em;
    width: 100%;
    max-width: 680px;
  }

  button, select, input[type="file"] {
    background: #21262d;
    color: #c9d1d9;
    border: 1px solid #30363d;
    border-radius: 8px;
    padding: 0.6em 1em;
    cursor: pointer;
    font-size: 1em;
  }

  button:hover, select:hover, input[type="file"]:hover {
    background: #30363d;
  }

  video, canvas {
    width: 100%;
    max-width: 680px;
    border-radius: 12px;
    margin-bottom: 0.5em;
  }

  #status {
    font-size: 0.9em;
    margin-top: 0.5em;
    color: #8b949e;
  }

  @media (max-width: 700px) {
    button, select, input[type="file"] {
      flex: 1 1 45%;
    }
  }
</style>
</head>
<body>

<h1>Smart Background Editor</h1>

<div id="controls">
  <input type="file" id="videoInput" accept="video/*">
  <select id="effectSelect">
    <option value="original">Original</option>
    <option value="blur">Blur Background</option>
    <option value="replace">Replace Background</option>
    <option value="grayscale">Grayscale Background</option>
    <option value="tint">Color Tint</option>
  </select>
  <input type="file" id="bgInput" accept="image/*" style="display:none;">
  <button id="startBtn">Start</button>
  <button id="stopBtn">Stop</button>
</div>

<video id="video" playsinline controls></video>
<canvas id="canvas"></canvas>
<div id="status">Ready</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const statusEl = document.getElementById('status');
  const videoInput = document.getElementById('videoInput');
  const effectSelect = document.getElementById('effectSelect');
  const bgInput = document.getElementById('bgInput');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');

  let segmentation;
  let running = false;
  let animationId;
  let bgImage = null;

  // Load video
  videoInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    stopProcessing();
    video.src = URL.createObjectURL(file);
    video.load();
    video.onloadeddata = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      statusEl.textContent = "Video loaded. Ready to start.";
    };
  });

  // Load background image
  bgInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const img = new Image();
    img.onload = () => { bgImage = img; };
    img.src = URL.createObjectURL(file);
  });

  // Show background selector only when needed
  effectSelect.addEventListener('change', () => {
    if (effectSelect.value === 'replace') {
      bgInput.style.display = 'inline-block';
    } else {
      bgInput.style.display = 'none';
    }
  });

  // Initialize segmentation
  async function initSegmentation() {
    segmentation = new SelfieSegmentation({
      locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
    });
    segmentation.setOptions({ modelSelection: 1 });
    await segmentation.initialize();
    statusEl.textContent = "Segmentation initialized.";
  }

  // Start processing
  startBtn.addEventListener('click', async () => {
    if (!video.src) return alert("Please select a video first.");
    if (!segmentation) await initSegmentation();
    running = true;
    video.play();
    processFrame();
  });

  // Stop processing
  stopBtn.addEventListener('click', stopProcessing);
  function stopProcessing() {
    running = false;
    cancelAnimationFrame(animationId);
    video.pause();
    statusEl.textContent = "Stopped.";
  }

  async function processFrame() {
    if (!running || video.paused || video.ended) {
      stopProcessing();
      return;
    }

    await segmentation.send({ image: video });
    const mask = segmentation.segmentationMask;

    const effect = effectSelect.value;

    // Draw background
    if (effect === 'replace' && bgImage) {
      ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
    } else if (effect === 'blur') {
      ctx.filter = 'blur(15px)';
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      ctx.filter = 'none';
    } else if (effect === 'grayscale') {
      ctx.filter = 'grayscale(1)';
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      ctx.filter = 'none';
    } else if (effect === 'tint') {
      ctx.fillStyle = 'rgba(50, 0, 80, 0.5)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    } else {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    }

    // Apply mask to isolate person
    ctx.globalCompositeOperation = 'destination-in';
    ctx.drawImage(mask, 0, 0, canvas.width, canvas.height);
    ctx.globalCompositeOperation = 'source-over';

    animationId = requestAnimationFrame(processFrame);
  }

  video.addEventListener('ended', () => stopProcessing());
</script>
</body>
</html>