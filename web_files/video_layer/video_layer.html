<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Video Cutout</title>
<style>
body {margin:0; font-family:Arial,sans-serif; background:#0d1117; color:#c9d1d9;
  display:flex; flex-direction:column; align-items:center; padding:1em;}
h1 {font-size:1.3em; margin-bottom:0.5em;}
video, canvas {width:100%; max-width:640px; border-radius:12px; background:black; margin-bottom:1em;}
#controls {display:flex; flex-wrap:wrap; gap:0.5em; justify-content:center; margin-bottom:1em;}
button,input[type=file]{background:#238636;color:white;border:none;padding:0.6em 1em;border-radius:8px;font-size:1em;cursor:pointer;}
button:disabled{background:#444c56;}
#status{font-size:0.9em;opacity:0.8;}
label{font-size:0.9em; margin-top:0.5em; color:#c9d1d9;}
input[type=range]{width:120px;}
</style>
</head>
<body>
<h1>AI Background Cutout</h1>
<div id="controls">
  <input type="file" id="videoInput" accept="video/*">
  <button id="startBtn" disabled>Start</button>
  <button id="stopBtn" disabled>Stop</button>
  <button id="downloadBtn" disabled>Download</button>
  <label>Feathering: <input type="range" id="featherSlider" min="0" max="20" value="5"></label>
</div>
<video id="video" playsinline controls></video>
<canvas id="canvas"></canvas>
<p id="status">Waiting for video...</p>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const input = document.getElementById('videoInput');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const downloadBtn = document.getElementById('downloadBtn');
const featherSlider = document.getElementById('featherSlider');
const status = document.getElementById('status');

let seg=null, mask=null, worker=null, running=false;
let mediaRecorder=null, recordedChunks=[];

async function initSeg(){
  seg = new SelfieSegmentation({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}` });
  seg.setOptions({ modelSelection: 1 });
  seg.onResults(r => { mask = r.segmentationMask; });
  await seg.initialize();
}
initSeg();

input.addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;
  video.src = URL.createObjectURL(file);
  video.load();
  video.onloadeddata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    startBtn.disabled = false;
    status.textContent = 'Ready to process.';
  };
});

startBtn.onclick = () => {
  if(!seg){ status.textContent='Model loading...'; return; }
  if(worker) worker.terminate();
  worker = new Worker('detector-worker.js');
  running = true;
  startBtn.disabled = true;
  stopBtn.disabled = false;
  downloadBtn.disabled = true;
  recordedChunks = [];

  // MediaRecorder to capture processed canvas
  const stream = canvas.captureStream(30);
  mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
  mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type:'video/webm' });
    const url = URL.createObjectURL(blob);
    video.src = url;
    video.controls = true;
    video.play();
    downloadBtn.onclick = () => {
      const a = document.createElement('a');
      a.href = url;
      a.download = 'segmented_video.webm';
      a.click();
    };
    downloadBtn.disabled = false;
    status.textContent = 'Processing complete. Play or download your video.';
  };
  mediaRecorder.start();

  loop();
};

stopBtn.onclick = () => {
  running=false;
  stopBtn.disabled=true;
  mediaRecorder?.stop();
  status.textContent='Stopped.';
};

function loop(){
  if(!running) return;
  if(video.paused || video.ended){
    requestAnimationFrame(loop);
    return;
  }

  seg.send({ image: video }).then(() => {
    if(!mask) return requestAnimationFrame(loop);
    const off = new OffscreenCanvas(canvas.width, canvas.height);
    const octx = off.getContext('2d');
    octx.drawImage(video,0,0,canvas.width,canvas.height);
    octx.globalCompositeOperation='destination-in';
    octx.drawImage(mask,0,0,canvas.width,canvas.height);

    const frame = octx.getImageData(0,0,canvas.width,canvas.height);
    worker.postMessage({ type:'blend', width: frame.width, height: frame.height, data: frame.data.buffer, feather: featherSlider.value }, [frame.data.buffer]);

    requestAnimationFrame(loop);
  });
}
</script>
</body>
</html>