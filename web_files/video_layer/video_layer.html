<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Video Cutout</title>
<style>
body {margin:0; font-family:Arial,sans-serif; background:#0d1117; color:#c9d1d9;
  display:flex; flex-direction:column; align-items:center; padding:1em;}
h1 {font-size:1.3em; margin-bottom:0.5em;}
video, canvas {width:100%; max-width:640px; border-radius:12px; background:black; margin-bottom:1em;}
#controls {display:flex; flex-wrap:wrap; gap:0.5em; justify-content:center; margin-bottom:1em;}
button,input[type=file],input[type=range] {
  background:#238636;color:white;border:none;padding:0.6em 1em;border-radius:8px;font-size:1em;cursor:pointer;
}
button:disabled{background:#444c56;}
#status{font-size:0.9em;opacity:0.8; margin-top:0.5em;}
label{font-size:0.9em; margin-top:0.5em;}
</style>
</head>
<body>
<h1>AI Video Background Cutout</h1>

<div id="controls">
  <input type="file" id="videoInput" accept="video/*">
  <button id="startBtn" disabled>Start</button>
  <button id="stopBtn" disabled>Stop</button>
  <button id="downloadBtn" disabled>Download</button>
  <label>Feathering:
    <input type="range" id="featherSlider" min="0" max="20" value="5">
  </label>
</div>

<video id="video" playsinline controls></video>
<canvas id="canvas"></canvas>
<p id="status">Select a video to begin.</p>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
<script type="module">
import { startVideoProcessing } from './detector.js';

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const input = document.getElementById('videoInput');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const downloadBtn = document.getElementById('downloadBtn');
const featherSlider = document.getElementById('featherSlider');
const status = document.getElementById('status');

let processedFrames = [];
let recorder = null;
let mediaStream = null;

input.addEventListener('change', e => {
  const f = e.target.files[0];
  if(!f) return;
  video.src = URL.createObjectURL(f);
  video.load();
  video.onloadeddata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    startBtn.disabled = false;
    status.textContent = 'Video loaded. Click Start to process.';
  };
});

startBtn.onclick = async () => {
  startBtn.disabled = true;
  stopBtn.disabled = false;
  processedFrames = [];
  status.textContent = 'Processing...';

  // Setup MediaRecorder to capture canvas
  mediaStream = canvas.captureStream(30); // 30 fps
  recorder = new MediaRecorder(mediaStream);
  const chunks = [];
  recorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
  recorder.onstop = () => {
    const blob = new Blob(chunks, { type:'video/webm' });
    const url = URL.createObjectURL(blob);
    downloadBtn.onclick = () => {
      const a = document.createElement('a');
      a.href = url;
      a.download = 'segmented_video.webm';
      a.click();
    };
    downloadBtn.disabled = false;
    video.src = url;
    video.controls = true;
    video.play();
    status.textContent = 'Processing complete. Play or download your video.';
  };
  recorder.start();

  // Start worker-based processing
  startVideoProcessing(video, canvas, ctx, frame => {
    processedFrames.push(frame);
  });
};

stopBtn.onclick = () => {
  stopBtn.disabled = true;
  recorder?.stop();
  status.textContent = 'Processing stopped.';
};
</script>
</body>
</html>