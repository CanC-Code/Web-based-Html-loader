<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI Video Layer Processor</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<h1>AI Video Layer Processor</h1>

<div id="controls">
  <input type="file" id="videoInput" accept="video/*">
  <select id="modelSelect">
    <option value="selfie">SelfieSegmentation</option>
    <option value="bodypix">BodyPix (Full Body)</option>
  </select>
  <label>Feather: <input type="range" id="feather" min="0" max="20" value="4"></label>
  <button id="startBtn" disabled>Start</button>
  <button id="stopBtn" disabled>Stop</button>
</div>

<div id="previewContainer">
  <video id="video" playsinline controls></video>
  <canvas id="canvas"></canvas>
</div>

<h2>Processed Output</h2>
<div id="outputContainer"></div>

<p id="status">Waiting for video...</p>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.8.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>
<script src="detector.js"></script>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const input = document.getElementById('videoInput');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const modelSelect = document.getElementById('modelSelect');
const featherInput = document.getElementById('feather');
const outputContainer = document.getElementById('outputContainer');
const status = document.getElementById('status');

let worker = null;
let running = false;
let frames = [];
let feather = parseInt(featherInput.value);
let detector = null;

async function initDetector(model='selfie') {
  detector = await Detector.init(model);
}

initDetector();

input.addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  video.src = URL.createObjectURL(file);
  video.onloadeddata = ()=>{
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    startBtn.disabled = false;
    status.textContent = 'Ready to process.';
  };
});

featherInput.addEventListener('input', e => {
  feather = parseInt(e.target.value);
});

modelSelect.addEventListener('change', e => {
  initDetector(modelSelect.value);
});

startBtn.onclick = () => {
  if(!detector){status.textContent='Model loading...'; return;}
  if(worker) worker.terminate();

  worker = new Worker('processor-worker.js');
  running = true;
  frames = [];
  startBtn.disabled = true;
  stopBtn.disabled = false;
  outputContainer.innerHTML = '';
  status.textContent = 'Processing...';

  worker.onmessage = e => {
    const msg = e.data;
    if(msg.type==='frame'){
      const img = new ImageData(new Uint8ClampedArray(msg.data), canvas.width, canvas.height);
      ctx.putImageData(img, 0, 0);
      frames.push(canvas.toDataURL('image/webp',0.8));
    } else if(msg.type==='done'){
      running = false;
      stopBtn.disabled = true;
      createOutputVideo();
      status.textContent = 'Processing complete.';
    }
  };

  video.play().catch(()=>{});
  processLoop();
};

stopBtn.onclick = () => {
  running = false;
  stopBtn.disabled = true;
  status.textContent='Stopped.';
  createOutputVideo();
};

function createOutputVideo() {
  if(frames.length===0) return;
  const mediaStream = canvas.captureStream(30);
  const recorder = new MediaRecorder(mediaStream);
  let chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, {type:'video/webm'});
    const outVid = document.createElement('video');
    outVid.controls = true;
    outVid.src = URL.createObjectURL(blob);
    outputContainer.appendChild(outVid);

    const a = document.createElement('a');
    a.href = outVid.src;
    a.download = 'processed_video.webm';
    a.textContent = 'Download Video';
    outputContainer.appendChild(a);
  };
  recorder.start();
  let frameIndex = 0;
  function feedFrames(){
    if(frameIndex>=frames.length){
      recorder.stop();
      return;
    }
    const img = new Image();
    img.onload = ()=>{
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      requestAnimationFrame(feedFrames);
    };
    img.src = frames[frameIndex];
    frameIndex++;
  }
  feedFrames();
}

function processLoop(){
  if(!running) return;
  if(video.paused || video.ended){running=false; stopBtn.disabled=true; createOutputVideo(); return;}
  detector.getMask(video).then(mask=>{
    if(!mask){requestAnimationFrame(processLoop); return;}
    const off = new OffscreenCanvas(canvas.width,canvas.height);
    const octx = off.getContext('2d');
    octx.drawImage(video,0,0,canvas.width,canvas.height);
    octx.globalCompositeOperation='destination-in';
    octx.filter=`blur(${feather}px)`;
    octx.drawImage(mask,0,0,canvas.width,canvas.height);
    const frame = octx.getImageData(0,0,canvas.width,canvas.height);
    worker.postMessage({type:'blend',width:frame.width,height:frame.height,data:frame.data.buffer},[frame.data.buffer]);
    requestAnimationFrame(processLoop);
  });
}
</script>

</body>
</html>