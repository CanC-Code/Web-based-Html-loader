<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Video Cutout</title>
<style>
body {margin:0; font-family:Arial,sans-serif; background:#0d1117; color:#c9d1d9;
  display:flex; flex-direction:column; align-items:center; padding:1em;}
h1 {font-size:1.3em; margin-bottom:0.5em;}
video,canvas {width:100%; max-width:640px; border-radius:12px; background:black; margin-bottom:1em;}
#controls {display:flex; flex-wrap:wrap; gap:0.5em; justify-content:center;}
button,input[type=file]{background:#238636;color:white;border:none;padding:0.6em 1em;border-radius:8px;font-size:1em;cursor:pointer;}
button:disabled{background:#444c56;}
#status{font-size:0.9em;opacity:0.8;}
</style>
</head>
<body>
<h1>AI Background Cutout</h1>
<div id="controls">
  <input type="file" id="videoInput" accept="video/*">
  <button id="startBtn" disabled>Start</button>
  <button id="downloadBtn" disabled>Download</button>
</div>
<video id="video" playsinline controls></video>
<canvas id="canvas"></canvas>
<p id="status">Waiting for video...</p>

<script type="module">
import { VideoDetectorWorker } from './detector-worker.js';

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const input = document.getElementById('videoInput');
const startBtn = document.getElementById('startBtn');
const downloadBtn = document.getElementById('downloadBtn');
const status = document.getElementById('status');

let workerDetector = null;
let outputURL = null;
let frameQueue = [];

input.addEventListener('change', e => {
  const f = e.target.files[0]; 
  if (!f) return;

  video.src = URL.createObjectURL(f);
  video.onloadeddata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    startBtn.disabled = false;
    status.textContent = 'Ready to start processing.';
  };
});

startBtn.onclick = () => {
  if (!workerDetector) {
    workerDetector = new VideoDetectorWorker(video, canvas, 5); // keep last 5 masks
    status.textContent = 'Initializing model...';
    workerDetector.init().then(() => {
      status.textContent = 'Processing...';
      startBtn.disabled = true;
      video.play();
      requestAnimationFrame(processFrameLoop);
    });
  }
};

async function processFrameLoop() {
  if(video.paused || video.ended) return;

  const bitmap = await createImageBitmap(video);
  workerDetector.enqueueFrame(bitmap);

  const frameData = workerDetector.getProcessedFrame();
  if(frameData){
    ctx.putImageData(frameData,0,0);
    frameQueue.push(frameData);
  }

  requestAnimationFrame(processFrameLoop);
}

video.onended = async () => {
  status.textContent = 'Encoding final video...';
  outputURL = await workerDetector.finalizeVideo();
  status.textContent = 'Processing complete! Play or download below.';

  const finalVideo = document.createElement('video');
  finalVideo.src = outputURL;
  finalVideo.controls = true;
  finalVideo.width = canvas.width;
  finalVideo.height = canvas.height;

  canvas.replaceWith(finalVideo);
  downloadBtn.disabled = false;
};

downloadBtn.onclick = () => {
  if (!outputURL) return;
  const a = document.createElement('a');
  a.href = outputURL;
  a.download = 'segmented_video.webm';
  a.click();
};
</script>
</body>
</html>