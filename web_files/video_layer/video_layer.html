<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Video Layer Processor</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
<script async src="https://docs.opencv.org/4.7.0/opencv.js"></script>
<script src="detector.js"></script>
</head>
<body>

<h1>AI Video Layer Processor</h1>

<div class="controls">
  <input type="file" id="videoInput" accept="video/*">
  <select id="effectSelect">
    <option value="none">No Effect</option>
    <option value="bgRemove">Background Removal</option>
    <option value="bgBlur">Background Blur</option>
    <option value="objectExclude">Object Exclusion</option>
  </select>
  <button id="startBtn">Start Processing</button>
  <button id="downloadBtn">Download Result</button>
</div>

<video id="sourceVideo" controls style="display:none"></video>
<canvas id="outputCanvas"></canvas>
<div id="status">Ready.</div>

<script>
const videoInput = document.getElementById('videoInput');
const effectSelect = document.getElementById('effectSelect');
const startBtn = document.getElementById('startBtn');
const downloadBtn = document.getElementById('downloadBtn');
const sourceVideo = document.getElementById('sourceVideo');
const canvas = document.getElementById('outputCanvas');
const status = document.getElementById('status');

let processor = null;
let mediaRecorder = null;
let recordedChunks = [];

videoInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  sourceVideo.src = URL.createObjectURL(file);
  sourceVideo.load();
  sourceVideo.style.display = "block";
  status.textContent = `Loaded video: ${file.name}`;
});

startBtn.addEventListener('click', async () => {
  if (!sourceVideo.src) return alert("Load a video first!");
  const effect = effectSelect.value;

  canvas.width = sourceVideo.videoWidth;
  canvas.height = sourceVideo.videoHeight;

  processor = new VideoProcessor(sourceVideo, canvas, effect);
  await processor.init();

  recordedChunks = [];
  const stream = canvas.captureStream(30);
  mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
  mediaRecorder.ondataavailable = e => { if (e.data.size>0) recordedChunks.push(e.data); };
  mediaRecorder.start();

  processor.onFinish = () => {
    mediaRecorder.stop();
    status.textContent = "Processing finished.";
  };

  processor.start();
  status.textContent = "Processing started...";
});

downloadBtn.addEventListener('click', () => {
  if (recordedChunks.length === 0) return alert("No processed video available!");
  const blob = new Blob(recordedChunks, { type: "video/webm" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "processed_video.webm";
  a.click();
});
</script>

</body>
</html>
