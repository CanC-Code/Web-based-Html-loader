<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI Video Segmentation</title>
<style>
  body {
    margin:0; padding:1em;
    font-family:Arial, sans-serif;
    background:#0d1117; color:#c9d1d9;
    display:flex; flex-direction:column; align-items:center;
    min-height:100vh;
  }
  h1 { color:#58a6ff; font-size:1.3rem; margin-bottom:1em; text-align:center; }
  video, canvas {
    width:100%; max-width:700px;
    border-radius:12px;
    background:#000;
    margin-bottom:1em;
  }
  #controls {
    display:flex; flex-wrap:wrap; justify-content:center;
    gap:0.5em; margin-top:0.5em;
  }
  button {
    background:#238636; color:white; border:none;
    padding:0.6em 1em; border-radius:8px; font-weight:600;
    cursor:pointer;
  }
  button:hover { background:#2ea043; }
  button:disabled { opacity:0.5; cursor:not-allowed; }
  #status { color:#8b949e; margin-top:0.5em; font-size:0.9rem; text-align:center; }
</style>
</head>
<body>

<h1>AI Video Background Remover</h1>

<input type="file" id="videoInput" accept="video/*">
<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>

<div id="controls">
  <button id="startBtn">‚ñ∂ Start Segmentation</button>
  <button id="stopBtn" disabled>‚èπ Stop</button>
  <button id="downloadBtn" disabled>üíæ Download Result</button>
</div>

<div id="status">Waiting for video...</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const input = document.getElementById('videoInput');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const downloadBtn = document.getElementById('downloadBtn');
const status = document.getElementById('status');

let worker;
let recordingChunks = [];
let mediaRecorder;
let running = false;

input.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  video.src = URL.createObjectURL(file);
  video.load();
  video.onloadeddata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    startBtn.disabled = false;
    status.textContent = "Video loaded. Ready to start segmentation.";
  };
});

startBtn.onclick = () => {
  if (!video.src) return;
  startBtn.disabled = true;
  stopBtn.disabled = false;
  status.textContent = "Starting segmentation...";
  startSegmentation();
};

stopBtn.onclick = stopSegmentation;

downloadBtn.onclick = () => {
  const blob = new Blob(recordingChunks, { type: 'video/webm' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'segmented_output.webm';
  a.click();
};

function startSegmentation() {
  if (running) return;
  running = true;

  worker = new Worker('processor-worker.js');
  worker.postMessage({ type: 'init', width: canvas.width, height: canvas.height });

  const stream = canvas.captureStream();
  mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
  recordingChunks = [];
  mediaRecorder.ondataavailable = e => recordingChunks.push(e.data);
  mediaRecorder.start();

  video.play().catch(()=>{});
  status.textContent = "Processing video...";

  function frameLoop() {
    if (!running || video.paused || video.ended) return;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
    worker.postMessage({ type: 'process', frame }, [frame.data.buffer]);
    video.requestVideoFrameCallback(frameLoop);
  }
  video.requestVideoFrameCallback(frameLoop);

  worker.onmessage = e => {
    if (e.data.type === 'render') {
      const img = new ImageData(e.data.data, e.data.width, e.data.height);
      ctx.putImageData(img, 0, 0);
    } else if (e.data.type === 'done') {
      stopSegmentation();
    }
  };
}

function stopSegmentation() {
  running = false;
  stopBtn.disabled = true;
  startBtn.disabled = false;
  worker?.terminate();
  video.pause();
  mediaRecorder?.stop();
  downloadBtn.disabled = false;
  status.textContent = "Processing stopped. Ready to download.";
}
</script>

</body>
</html>